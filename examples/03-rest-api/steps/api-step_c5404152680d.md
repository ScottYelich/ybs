# Step 2: Create Main Client Script

**Step ID**: c5404152680d
**System**: rest-api-client
**Version**: 1.0.0
**Estimated Time**: 10 minutes
**Depends On**: Step 1 (Initialize Project Structure)

---

## Context

**What**: Create the main REST API client script with HTTP request handling, JSON parsing, and error handling

**Why**: This is the core functionality that fetches data from the API and displays it

**Implements**:
- rest-api-client-spec.md § 2.1 F1 (Fetch Posts)
- rest-api-client-spec.md § 2.1 F2 (Fetch Users)
- rest-api-client-spec.md § 2.1 F3 (Fetch Todos)
- rest-api-client-spec.md § 2.1 F4 (JSON Display)
- rest-api-client-spec.md § 2.1 F5 (Error Handling)
- rest-api-client-spec.md § 2.1 F6 (CLI Interface)

---

## Prerequisites

- ✅ Step 1 complete (project structure initialized)
- ✅ BUILD_CONFIG.json readable
- ✅ Build directory exists

---

## Instructions

### 1. Read Configuration

Load configuration from BUILD_CONFIG.json:

```python
import json
with open('BUILD_CONFIG.json') as f:
    config = json.load(f)
```

Extract values:
- `{{CONFIG:language}}` - Implementation language
- `{{CONFIG:api_base_url}}` - API base URL
- `{{CONFIG:json_indent}}` - JSON indentation
- `{{CONFIG:timeout}}` - Request timeout

---

### 2. Create Client Script (Language-Specific)

#### **For Python** ({{CONFIG:language}} == "python"):

Create `api_client.py`:

```python
#!/usr/bin/env python3
"""
REST API Client for JSONPlaceholder
Implements: rest-api-client-spec.md
"""

import sys
import json
import requests
from typing import Optional, Union, Dict, List

# Configuration from BUILD_CONFIG.json
# Implements: rest-api-client-spec.md § 3.1 C3, C5, C6
API_BASE = "{{CONFIG:api_base_url}}"
JSON_INDENT = {{CONFIG:json_indent}}
TIMEOUT = {{CONFIG:timeout}}


def fetch_data(endpoint: str, item_id: Optional[str] = None) -> Union[Dict, List]:
    """
    Fetch data from API endpoint.

    Implements: rest-api-client-spec.md § 2.1 F1 (Fetch Posts)
    Implements: rest-api-client-spec.md § 2.1 F2 (Fetch Users)
    Implements: rest-api-client-spec.md § 2.1 F3 (Fetch Todos)
    Implements: rest-api-client-spec.md § 2.1 F5 (Error Handling)

    Args:
        endpoint: API endpoint (posts, users, todos, comments)
        item_id: Optional item ID for single resource

    Returns:
        JSON data (dict or list)

    Raises:
        SystemExit: On network or HTTP errors
    """
    try:
        # Build URL
        url = f"{API_BASE}/{endpoint}"
        if item_id:
            url += f"/{item_id}"

        # Make HTTP GET request
        response = requests.get(url, timeout=TIMEOUT)

        # Raise exception for HTTP errors (4xx, 5xx)
        response.raise_for_status()

        # Parse and return JSON
        return response.json()

    except requests.exceptions.Timeout:
        print(f"Error: Request timeout after {TIMEOUT} seconds", file=sys.stderr)
        sys.exit(1)

    except requests.exceptions.ConnectionError as e:
        print(f"Error: Connection failed - {e}", file=sys.stderr)
        sys.exit(1)

    except requests.exceptions.HTTPError as e:
        print(f"Error: HTTP {response.status_code} - {e}", file=sys.stderr)
        sys.exit(1)

    except json.JSONDecodeError as e:
        print(f"Error: Invalid JSON in response - {e}", file=sys.stderr)
        sys.exit(1)

    except requests.exceptions.RequestException as e:
        print(f"Error: Request failed - {e}", file=sys.stderr)
        sys.exit(1)


def display_json(data: Union[Dict, List], indent: int = JSON_INDENT) -> None:
    """
    Display JSON data with pretty printing.

    Implements: rest-api-client-spec.md § 2.1 F4 (JSON Display)

    Args:
        data: JSON data to display
        indent: Number of spaces for indentation
    """
    print(json.dumps(data, indent=indent))


def main() -> None:
    """
    Main CLI entry point.

    Implements: rest-api-client-spec.md § 2.1 F6 (CLI Interface)
    """
    # Check arguments
    if len(sys.argv) < 2:
        print("Usage: api_client.py <endpoint> [id]", file=sys.stderr)
        print("", file=sys.stderr)
        print("Endpoints:", file=sys.stderr)
        print("  posts    - Blog posts", file=sys.stderr)
        print("  users    - User accounts", file=sys.stderr)
        print("  todos    - Todo items", file=sys.stderr)
        print("  comments - Post comments", file=sys.stderr)
        print("", file=sys.stderr)
        print("Examples:", file=sys.stderr)
        print("  api_client.py posts      # List all posts", file=sys.stderr)
        print("  api_client.py posts 1    # Get post ID 1", file=sys.stderr)
        print("  api_client.py users 5    # Get user ID 5", file=sys.stderr)
        sys.exit(1)

    # Parse arguments
    endpoint = sys.argv[1]
    item_id = sys.argv[2] if len(sys.argv) > 2 else None

    # Validate endpoint
    valid_endpoints = ['posts', 'users', 'todos', 'comments']
    if endpoint not in valid_endpoints:
        print(f"Error: Invalid endpoint '{endpoint}'", file=sys.stderr)
        print(f"Valid endpoints: {', '.join(valid_endpoints)}", file=sys.stderr)
        sys.exit(1)

    # Fetch and display data
    data = fetch_data(endpoint, item_id)
    display_json(data)


if __name__ == "__main__":
    main()
```

**Set executable permissions**:
```bash
chmod +x api_client.py
```

---

#### **For JavaScript** ({{CONFIG:language}} == "javascript"):

Create `api_client.js`:

```javascript
#!/usr/bin/env node
/**
 * REST API Client for JSONPlaceholder
 * Implements: rest-api-client-spec.md
 */

const https = require('https');
const { URL } = require('url');

// Configuration from BUILD_CONFIG.json
// Implements: rest-api-client-spec.md § 3.1 C3, C5, C6
const API_BASE = '{{CONFIG:api_base_url}}';
const JSON_INDENT = {{CONFIG:json_indent}};
const TIMEOUT = {{CONFIG:timeout}} * 1000; // Convert to milliseconds

/**
 * Fetch data from API endpoint.
 *
 * Implements: rest-api-client-spec.md § 2.1 F1 (Fetch Posts)
 * Implements: rest-api-client-spec.md § 2.1 F2 (Fetch Users)
 * Implements: rest-api-client-spec.md § 2.1 F3 (Fetch Todos)
 * Implements: rest-api-client-spec.md § 2.1 F5 (Error Handling)
 *
 * @param {string} endpoint - API endpoint (posts, users, todos, comments)
 * @param {string|null} itemId - Optional item ID for single resource
 * @returns {Promise<Object|Array>} JSON data
 */
function fetchData(endpoint, itemId = null) {
  return new Promise((resolve, reject) => {
    // Build URL
    let path = `/${endpoint}`;
    if (itemId) {
      path += `/${itemId}`;
    }

    const url = new URL(path, API_BASE);

    // Make HTTP GET request
    const req = https.get({
      hostname: url.hostname,
      path: url.pathname,
      timeout: TIMEOUT,
      headers: {
        'User-Agent': 'rest-api-client/1.0'
      }
    }, (res) => {
      let data = '';

      res.on('data', chunk => {
        data += chunk;
      });

      res.on('end', () => {
        // Check HTTP status
        if (res.statusCode >= 400) {
          reject(new Error(`HTTP ${res.statusCode} - ${res.statusMessage}`));
          return;
        }

        // Parse JSON
        try {
          const jsonData = JSON.parse(data);
          resolve(jsonData);
        } catch (e) {
          reject(new Error(`Invalid JSON in response: ${e.message}`));
        }
      });
    });

    req.on('error', (error) => {
      reject(new Error(`Connection failed: ${error.message}`));
    });

    req.on('timeout', () => {
      req.destroy();
      reject(new Error(`Request timeout after ${TIMEOUT / 1000} seconds`));
    });
  });
}

/**
 * Display JSON data with pretty printing.
 *
 * Implements: rest-api-client-spec.md § 2.1 F4 (JSON Display)
 *
 * @param {Object|Array} data - JSON data to display
 * @param {number} indent - Number of spaces for indentation
 */
function displayJson(data, indent = JSON_INDENT) {
  console.log(JSON.stringify(data, null, indent));
}

/**
 * Main CLI entry point.
 *
 * Implements: rest-api-client-spec.md § 2.1 F6 (CLI Interface)
 */
async function main() {
  const args = process.argv.slice(2);

  // Check arguments
  if (args.length < 1) {
    console.error('Usage: api_client.js <endpoint> [id]');
    console.error('');
    console.error('Endpoints:');
    console.error('  posts    - Blog posts');
    console.error('  users    - User accounts');
    console.error('  todos    - Todo items');
    console.error('  comments - Post comments');
    console.error('');
    console.error('Examples:');
    console.error('  api_client.js posts      # List all posts');
    console.error('  api_client.js posts 1    # Get post ID 1');
    console.error('  api_client.js users 5    # Get user ID 5');
    process.exit(1);
  }

  // Parse arguments
  const [endpoint, itemId] = args;

  // Validate endpoint
  const validEndpoints = ['posts', 'users', 'todos', 'comments'];
  if (!validEndpoints.includes(endpoint)) {
    console.error(`Error: Invalid endpoint '${endpoint}'`);
    console.error(`Valid endpoints: ${validEndpoints.join(', ')}`);
    process.exit(1);
  }

  // Fetch and display data
  try {
    const data = await fetchData(endpoint, itemId);
    displayJson(data);
  } catch (error) {
    console.error(`Error: ${error.message}`);
    process.exit(1);
  }
}

// Run main
main();
```

**Set executable permissions**:
```bash
chmod +x api_client.js
```

---

#### **For Ruby** ({{CONFIG:language}} == "ruby"):

Create `api_client.rb`:

```ruby
#!/usr/bin/env ruby
# REST API Client for JSONPlaceholder
# Implements: rest-api-client-spec.md

require 'net/http'
require 'json'
require 'uri'

# Configuration from BUILD_CONFIG.json
# Implements: rest-api-client-spec.md § 3.1 C3, C5, C6
API_BASE = '{{CONFIG:api_base_url}}'
JSON_INDENT = {{CONFIG:json_indent}}
TIMEOUT = {{CONFIG:timeout}}

##
# Fetch data from API endpoint.
#
# Implements: rest-api-client-spec.md § 2.1 F1 (Fetch Posts)
# Implements: rest-api-client-spec.md § 2.1 F2 (Fetch Users)
# Implements: rest-api-client-spec.md § 2.1 F3 (Fetch Todos)
# Implements: rest-api-client-spec.md § 2.1 F5 (Error Handling)
#
# @param endpoint [String] API endpoint (posts, users, todos, comments)
# @param item_id [String, nil] Optional item ID for single resource
# @return [Hash, Array] JSON data
def fetch_data(endpoint, item_id = nil)
  # Build URL
  path = "/#{endpoint}"
  path += "/#{item_id}" if item_id

  uri = URI.join(API_BASE, path)

  # Make HTTP GET request
  begin
    response = Net::HTTP.start(uri.host, uri.port,
                                use_ssl: uri.scheme == 'https',
                                read_timeout: TIMEOUT,
                                open_timeout: TIMEOUT) do |http|
      request = Net::HTTP::Get.new(uri)
      http.request(request)
    end

    # Check HTTP status
    unless response.is_a?(Net::HTTPSuccess)
      $stderr.puts "Error: HTTP #{response.code} - #{response.message}"
      exit 1
    end

    # Parse JSON
    JSON.parse(response.body)

  rescue Net::OpenTimeout, Net::ReadTimeout
    $stderr.puts "Error: Request timeout after #{TIMEOUT} seconds"
    exit 1
  rescue SocketError, Errno::ECONNREFUSED => e
    $stderr.puts "Error: Connection failed - #{e.message}"
    exit 1
  rescue JSON::ParserError => e
    $stderr.puts "Error: Invalid JSON in response - #{e.message}"
    exit 1
  rescue StandardError => e
    $stderr.puts "Error: Request failed - #{e.message}"
    exit 1
  end
end

##
# Display JSON data with pretty printing.
#
# Implements: rest-api-client-spec.md § 2.1 F4 (JSON Display)
#
# @param data [Hash, Array] JSON data to display
# @param indent [Integer] Number of spaces for indentation
def display_json(data, indent = JSON_INDENT)
  puts JSON.pretty_generate(data, indent: ' ' * indent)
end

##
# Main CLI entry point.
#
# Implements: rest-api-client-spec.md § 2.1 F6 (CLI Interface)
def main
  # Check arguments
  if ARGV.empty?
    $stderr.puts 'Usage: api_client.rb <endpoint> [id]'
    $stderr.puts ''
    $stderr.puts 'Endpoints:'
    $stderr.puts '  posts    - Blog posts'
    $stderr.puts '  users    - User accounts'
    $stderr.puts '  todos    - Todo items'
    $stderr.puts '  comments - Post comments'
    $stderr.puts ''
    $stderr.puts 'Examples:'
    $stderr.puts '  api_client.rb posts      # List all posts'
    $stderr.puts '  api_client.rb posts 1    # Get post ID 1'
    $stderr.puts '  api_client.rb users 5    # Get user ID 5'
    exit 1
  end

  # Parse arguments
  endpoint = ARGV[0]
  item_id = ARGV[1]

  # Validate endpoint
  valid_endpoints = %w[posts users todos comments]
  unless valid_endpoints.include?(endpoint)
    $stderr.puts "Error: Invalid endpoint '#{endpoint}'"
    $stderr.puts "Valid endpoints: #{valid_endpoints.join(', ')}"
    exit 1
  end

  # Fetch and display data
  data = fetch_data(endpoint, item_id)
  display_json(data)
end

# Run main
main if __FILE__ == $PROGRAM_NAME
```

**Set executable permissions**:
```bash
chmod +x api_client.rb
```

---

### 3. Quick Test

Test the script manually:

**Python**:
```bash
python3 api_client.py posts 1
```

**JavaScript**:
```bash
node api_client.js posts 1
```

**Ruby**:
```bash
ruby api_client.rb posts 1
```

**Expected output**: JSON object for post ID 1

---

## Verification

**This step is complete when:**
- ✅ Client script created with correct filename
- ✅ Script has executable permissions (chmod +x)
- ✅ Script has proper shebang line
- ✅ All traceability comments present
- ✅ Script runs without syntax errors
- ✅ Manual test with `posts 1` returns valid JSON
- ✅ Error handling code present for all error types
- ✅ Help message displays on no arguments

**Verification Commands**:
```bash
# Check file exists
[ -f api_client.* ] && echo "✅ Script exists" || echo "❌ Missing"

# Check executable
[ -x api_client.* ] && echo "✅ Executable" || echo "❌ Not executable"

# Check traceability
grep -q "Implements: rest-api-client-spec.md" api_client.* && echo "✅ Traceability" || echo "❌ Missing"

# Test run (requires internet)
./api_client.* posts 1 && echo "✅ Script works" || echo "❌ Execution failed"
```

**Retry Limit**: 3 attempts

---

## Troubleshooting

**Problem**: Syntax errors in script
**Solution**: Review language-specific syntax, check indentation

**Problem**: Import/require errors (Python requests, etc.)
**Solution**: Install dependencies from Step 1 (requirements.txt)

**Problem**: Network connection failed during test
**Solution**: Check internet connection, verify JSONPlaceholder is accessible

**Problem**: Permission denied executing script
**Solution**: Run `chmod +x api_client.*`

---

## Next Step

**Step 3**: Create Test Suite

---

## References

- **Specification**: [../specs/rest-api-client-spec.md](../specs/rest-api-client-spec.md) § 2.1, § 4.3
- **YBS Framework**: [../../framework/methodology/executing-builds.md](../../framework/methodology/executing-builds.md)

---

**End of Step 2**
