#!/bin/bash
set -e

# ==============================================================================
# searxng - SearXNG Management Script for Bootstrap
# ==============================================================================
#
# Manages the SearXNG web search server used by the bootstrap system.
#
# USAGE:
#   searxng start      Start SearXNG server
#   searxng stop       Stop SearXNG server
#   searxng restart    Restart SearXNG server
#   searxng status     Show server status
#   searxng logs       Show server logs (tail -f)
#   searxng test       Test search functionality
#   searxng --help     Show this help message
#
# LOCATION:
#   Server runs at: http://127.0.0.1:38888
#   Installation: ~/.config/searxng/
#
# RESOURCES:
#   RAM: ~30-50 MB
#   Monthly Limit: Unlimited
#   Cost: $0 (self-hosted)
#
# ==============================================================================

SEARXNG_DIR="$HOME/.config/searxng"
PIDFILE="$SEARXNG_DIR/searxng.pid"
LOGFILE="$SEARXNG_DIR/searxng.log"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print colored output
print_success() { echo -e "${GREEN}✅ $1${NC}"; }
print_error() { echo -e "${RED}❌ $1${NC}"; }
print_info() { echo -e "${BLUE}ℹ️  $1${NC}"; }
print_warning() { echo -e "${YELLOW}⚠️  $1${NC}"; }

# Show help
show_help() {
  cat <<'EOF'
SearXNG Management Script

USAGE:
  searxng start      Start SearXNG server
  searxng stop       Stop SearXNG server
  searxng restart    Restart SearXNG server
  searxng status     Show server status
  searxng logs       Show server logs (tail -f)
  searxng test       Test search functionality
  searxng --help     Show this help message

DESCRIPTION:
  SearXNG is a self-hosted meta-search engine that provides unlimited
  web searches with zero cost and no API keys required.

RESOURCES:
  • URL: http://127.0.0.1:38888
  • RAM Usage: ~30-50 MB
  • Monthly Limit: Unlimited
  • Cost: $0 (self-hosted)
  • Installation: ~/.config/searxng/

SETUP:
  SearXNG is already installed and configured. Just run:
    searxng start

AUTO-START:
  To start SearXNG automatically on login, run:
    searxng autostart

EXAMPLES:
  # Start the server
  searxng start

  # Check if it's running
  searxng status

  # Test a search
  searxng test

  # View real-time logs
  searxng logs

  # Stop the server
  searxng stop

TROUBLESHOOTING:
  If searches fail:
    1. Check status: searxng status
    2. View logs: searxng logs
    3. Restart: searxng restart

  If port 8888 is in use:
    lsof -i :8888

FILES:
  ~/.config/searxng/
  ├── start.sh           Start script
  ├── stop.sh            Stop script
  ├── settings.yml       Configuration
  ├── searxng.pid        Process ID (when running)
  ├── searxng.log        Server logs
  └── README.md          Full documentation

DOCUMENTATION:
  Full setup guide: ~/.config/searxng/README.md

EOF
}

# Check if SearXNG is running
is_running() {
  if [ -f "$PIDFILE" ]; then
    PID=$(cat "$PIDFILE")
    if kill -0 "$PID" 2>/dev/null; then
      return 0  # Running
    fi
  fi
  return 1  # Not running
}

# Start SearXNG
cmd_start() {
  if is_running; then
    print_warning "SearXNG is already running (PID: $(cat $PIDFILE))"
    return 0
  fi

  print_info "Starting SearXNG..."
  "$SEARXNG_DIR/start.sh"

  # Wait and verify
  sleep 1
  if is_running; then
    print_success "SearXNG started successfully"
    print_info "URL: http://127.0.0.1:38888"
  else
    print_error "Failed to start SearXNG"
    print_info "Check logs: searxng logs"
    return 1
  fi
}

# Stop SearXNG
cmd_stop() {
  if ! is_running; then
    print_info "SearXNG is not running"
    return 0
  fi

  print_info "Stopping SearXNG..."
  "$SEARXNG_DIR/stop.sh"
  print_success "SearXNG stopped"
}

# Restart SearXNG
cmd_restart() {
  print_info "Restarting SearXNG..."
  cmd_stop
  sleep 1
  cmd_start
}

# Show status
cmd_status() {
  echo ""
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo "SearXNG Status"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ""

  if is_running; then
    PID=$(cat "$PIDFILE")
    print_success "Running (PID: $PID)"
    echo ""
    echo "  URL:           http://127.0.0.1:38888"
    echo "  Monthly Limit: Unlimited"
    echo "  Cost:          \$0 (self-hosted)"
    echo "  RAM Usage:     ~30-50 MB"
    echo ""

    # Test connectivity
    if curl -s --max-time 2 "http://127.0.0.1:38888" > /dev/null 2>&1; then
      print_success "Server responding"
    else
      print_warning "Server not responding (might be starting up)"
    fi
  else
    print_error "Not running"
    echo ""
    echo "  Start with: searxng start"
  fi

  echo ""
  echo "  Log file: $LOGFILE"
  echo "  PID file: $PIDFILE"
  echo ""
}

# Show logs
cmd_logs() {
  if [ ! -f "$LOGFILE" ]; then
    print_error "No log file found at $LOGFILE"
    return 1
  fi

  print_info "Showing logs (Ctrl+C to exit)..."
  echo ""
  tail -f "$LOGFILE"
}

# Test search
cmd_test() {
  print_info "Testing SearXNG search..."
  echo ""

  # Check if running
  if ! is_running; then
    print_error "SearXNG is not running"
    echo ""
    echo "Start it with: searxng start"
    return 1
  fi

  # Test search
  QUERY="test"
  print_info "Query: '$QUERY'"

  RESPONSE=$(curl -s --max-time 10 "http://127.0.0.1:38888/search?q=${QUERY}&format=json" 2>/dev/null)

  if [ $? -ne 0 ] || [ -z "$RESPONSE" ]; then
    print_error "Failed to connect to SearXNG"
    echo ""
    echo "Try:"
    echo "  1. Check status: searxng status"
    echo "  2. View logs: searxng logs"
    echo "  3. Restart: searxng restart"
    return 1
  fi

  # Count results
  RESULT_COUNT=$(echo "$RESPONSE" | jq -r '.results | length' 2>/dev/null)

  if [ -z "$RESULT_COUNT" ] || [ "$RESULT_COUNT" = "null" ]; then
    print_error "Invalid response from SearXNG"
    return 1
  fi

  print_success "Search successful"
  echo ""
  echo "  Results found: $RESULT_COUNT"
  echo ""

  # Show first 3 results
  echo "First 3 results:"
  echo "$RESPONSE" | jq -r '.results[0:3] | .[] | "  • \(.title)\n    \(.url)\n"' 2>/dev/null

  print_success "SearXNG is working correctly"
}

# Setup auto-start
cmd_autostart() {
  PLIST="$HOME/Library/LaunchAgents/com.searxng.plist"

  if [ -f "$PLIST" ]; then
    print_info "Auto-start is already configured"
    echo ""
    echo "To disable:"
    echo "  launchctl unload $PLIST"
    echo "  rm $PLIST"
    return 0
  fi

  print_info "Setting up auto-start..."

  mkdir -p "$HOME/Library/LaunchAgents"

  cat > "$PLIST" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.searxng</string>
    <key>ProgramArguments</key>
    <array>
        <string>$SEARXNG_DIR/start.sh</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <false/>
</dict>
</plist>
EOF

  launchctl load "$PLIST"

  print_success "Auto-start configured"
  echo ""
  echo "SearXNG will now start automatically on login"
}

# Main command dispatcher
case "${1:-}" in
  start)
    cmd_start
    ;;
  stop)
    cmd_stop
    ;;
  restart)
    cmd_restart
    ;;
  status)
    cmd_status
    ;;
  logs)
    cmd_logs
    ;;
  test)
    cmd_test
    ;;
  autostart)
    cmd_autostart
    ;;
  --help|-h|help)
    show_help
    ;;
  "")
    show_help
    ;;
  *)
    print_error "Unknown command: $1"
    echo ""
    echo "Run 'searxng --help' for usage information"
    exit 1
    ;;
esac
