# Step 000000: Build Configuration (Step 0)

**Version**: 0.1.0

## Overview

This step collects all configurable values from all build steps and generates a central BUILD_CONFIG.json file. This enables fully autonomous execution of subsequent steps without user intervention.

## What This Step Builds

A BUILD_CONFIG.json file containing all configuration values needed by the entire build, including:
- System name
- Programming language choice
- Target platform(s)
- Any other configurable values defined in steps 1-N

## Step Objectives

1. Scan all step files in STEPS_ORDER.txt
2. Extract all `{{CONFIG:...}}` markers
3. Deduplicate and organize configuration values
4. Ask user for all values using AskUserQuestion (max 4 questions per batch)
5. Generate BUILD_CONFIG.json
6. Verify configuration file is valid JSON
7. Document completion

## Prerequisites

- STEPS_ORDER.txt must exist and contain step GUIDs
- All step files must be present in steps/ directory
- No other steps should be executed before this one

## Configurable Values

This step has no configurable values (it's the step that collects them).

## Traceability

**Implements**: Infrastructure step - enables configuration-driven builds

**References**:
- Framework design pattern: configuration before execution

## Instructions

### Before Starting

**Record start time**: Note the current timestamp (ISO 8601: YYYY-MM-DD HH:MM UTC)

### 1. Read STEPS_ORDER.txt

Read the file `steps/STEPS_ORDER.txt` to get the ordered list of step GUIDs.

**Commands**:
```bash
cat steps/STEPS_ORDER.txt
```

**Extract**: All non-comment, non-empty lines containing 12-hex GUIDs

### 2. Scan All Step Files for CONFIG Markers

For each step GUID in STEPS_ORDER.txt:
1. Read the step file `steps/ybs-step_<guid>.md`
2. Search for all instances of `{{CONFIG:...}}` markers
3. Extract the pattern: `{{CONFIG:key|type|description|default}}`

**Regex pattern**: `\{\{CONFIG:([^|]+)\|([^|]+)\|([^|]+)\|([^}]+)\}\}`

**Groups**:
- Group 1: key name
- Group 2: type (string, choice[...], boolean, etc.)
- Group 3: description
- Group 4: default value

### 3. Deduplicate Configuration Values

If the same key appears in multiple steps:
- Use the FIRST occurrence's type, description, and default
- Make note that this key is used by multiple steps

**Example**: If both step 1 and step 2 have `{{CONFIG:system_name|...}}`, only ask once.

### 4. Organize Questions for User

Group configuration values into logical batches:
- **Batch 1**: Essential (system_name, language, platform)
- **Batch 2**: Optional/Advanced (colors, URLs, feature flags)

**Rules**:
- Maximum 4 questions per AskUserQuestion call
- If more than 4 values, use multiple batches
- Present in order of importance

### 5. Ask User for All Values

Use AskUserQuestion tool to collect values:

**For each configurable value**:
- **question**: Use the description from CONFIG marker
- **header**: Use shortened version of key name (max 12 chars)
- **options**:
  - For `choice[A,B,C]`: Create options for A, B, C
  - For `string`, `integer`, etc.: Provide reasonable options or use "Other" for free text
- **default**: Highlight the default value in option description

**Example for `{{CONFIG:language|choice[Swift,Python,Go]|Programming language|Swift}}`**:
```json
{
  "question": "Which programming language should be used?",
  "header": "Language",
  "options": [
    {
      "label": "Swift (Recommended)",
      "description": "Native macOS development, fast startup, type-safe"
    },
    {
      "label": "Python",
      "description": "Cross-platform, extensive libraries, slower startup"
    },
    {
      "label": "Go",
      "description": "Fast, simple, good concurrency, single binary"
    }
  ]
}
```

### 6. Generate BUILD_CONFIG.json

After collecting all values, create the configuration file.

**Location**: `builds/{{CONFIG:system_name}}/BUILD_CONFIG.json`

**Note**: If `system_name` wasn't collected, use "default" as the system name.

**Format**:
```json
{
  "version": "0.1.0",
  "generated": "2026-01-17T05:30:00Z",
  "system_name": "{{value from user}}",
  "values": {
    "system_name": "{{value}}",
    "language": "{{value}}",
    "platform": "{{value}}",
    "...": "..."
  },
  "metadata": {
    "total_steps": 3,
    "config_sources": [
      "ybs-step_478a8c4b0cef",
      "ybs-step_c5404152680d",
      "ybs-step_89b9e6233da5"
    ]
  }
}
```

**Fields**:
- `version`: Config schema version (0.1.0)
- `generated`: ISO 8601 timestamp when config was created
- `system_name`: Name of the system (top-level for convenience)
- `values`: Key-value pairs of all configuration values
- `metadata.total_steps`: Count of steps in STEPS_ORDER.txt
- `metadata.config_sources`: List of step GUIDs that had CONFIG markers

### 7. Create Build Directory Structure

If this is the first step (no `builds/{{system_name}}/` exists):

```bash
mkdir -p builds/{{system_name}}/docs/build-history
touch builds/{{system_name}}/docs/build-history/.gitkeep
```

### 8. Verify BUILD_CONFIG.json

**Validation checks**:
- [ ] File exists at correct path
- [ ] Valid JSON (can be parsed)
- [ ] Has all required top-level keys: version, generated, system_name, values
- [ ] All configuration keys are present in `values` object
- [ ] Timestamp is in ISO 8601 format

**Validation command**:
```bash
cat builds/{{system_name}}/BUILD_CONFIG.json | python3 -m json.tool > /dev/null && echo "Valid JSON"
```

## Verification

**This step is complete when**:
- [ ] All step files scanned for CONFIG markers
- [ ] All configuration values collected from user
- [ ] BUILD_CONFIG.json created with valid JSON
- [ ] Build directory structure exists
- [ ] All required fields present in config file
- [ ] Timestamp is correct ISO 8601 format

**Verification Commands**:
```bash
# Check file exists
test -f builds/{{system_name}}/BUILD_CONFIG.json && echo "Config file exists"

# Validate JSON
python3 -m json.tool builds/{{system_name}}/BUILD_CONFIG.json > /dev/null && echo "Valid JSON"

# Check required fields
cat builds/{{system_name}}/BUILD_CONFIG.json | python3 -c "
import json, sys
config = json.load(sys.stdin)
required = ['version', 'generated', 'system_name', 'values']
missing = [k for k in required if k not in config]
if missing:
    print(f'Missing fields: {missing}')
    sys.exit(1)
print('All required fields present')
"
```

**Expected Output**:
```
Config file exists
Valid JSON
All required fields present
```

**Retry Policy**:
- If verification fails, analyze the error and fix the issue
- Maximum 3 attempts allowed
- After 3 failures, STOP and report to user

**Verification Tracking**:
- Attempt 1: [timestamp] - [result]
- Attempt 2 (if needed): [timestamp] - [result]
- Attempt 3 (if needed): [timestamp] - [result]

## Documentation

### Create Initial BUILD_STATUS.md

If this is the first step, also create `builds/{{system_name}}/BUILD_STATUS.md`:

```markdown
# Build Status: {{system_name}}

**Version**: 0.1.0
**System Name**: {{system_name}}
**Current Step**: ybs-step_000000000000
**Step Version**: 0.1.0
**Status**: completed
**Last Updated**: {{current_timestamp}}

## Current Step Details
- **Title**: Build Configuration (Step 0)
- **Status**: completed
- **Issues**: none

## Progress Metrics
- **Total steps**: {{count from STEPS_ORDER.txt}}
- **Steps completed**: 1 (Step 0)
- **Steps remaining**: {{total - 1}}
- **Completion**: {{percentage}}%
- **Average step duration**: N/A (first step)
- **Estimated time remaining**: Unknown

## Next Action
Ready to proceed to ybs-step_{{next_guid}} ({{next_title}}).

## Configuration
- **Config file**: BUILD_CONFIG.json
- **Generated**: {{timestamp}}
- **Values collected**: {{count}}
```

### Create Completion Documentation

**Record end time**: Note the completion timestamp (ISO 8601: YYYY-MM-DD HH:MM UTC)

**Calculate duration**: End time - Start time

Create `builds/{{system_name}}/docs/build-history/ybs-step_000000000000-DONE.txt`:

```
STEP 000000000000: Build Configuration (Step 0)
STARTED: {{start_timestamp}}
COMPLETED: {{end_timestamp}}
DURATION: {{duration in minutes}}

OBJECTIVES:
- Scan all step files for configurable values
- Collect all values from user
- Generate BUILD_CONFIG.json
- Verify configuration is valid

ACTIONS TAKEN:
- Read STEPS_ORDER.txt (found {{N}} steps)
- Scanned {{N}} step files for CONFIG markers
- Found {{N}} unique configuration values
- Asked user for {{N}} values in {{N}} batches
- Generated BUILD_CONFIG.json with {{N}} values
- Created build directory structure
- Verified JSON is valid

VERIFICATION RESULTS:
✓ BUILD_CONFIG.json exists
✓ Valid JSON format
✓ All required fields present
✓ All configuration values collected
✓ Build directory structure created

VERIFICATION ATTEMPTS: 1

ISSUES ENCOUNTERED:
{{none or list issues and resolutions}}

FILES CREATED:
- builds/{{system_name}}/BUILD_CONFIG.json
- builds/{{system_name}}/BUILD_STATUS.md (if first step)
- builds/{{system_name}}/docs/build-history/.gitkeep

CONFIGURATION VALUES COLLECTED:
{{list of keys and values}}

NEXT STEP: ybs-step_{{next_guid}} ({{next_title}})

TIMING SUMMARY:
- Start: {{start_timestamp}}
- End: {{end_timestamp}}
- Duration: {{duration}}
```

## Success Criteria

This step is successful when:
1. All CONFIG markers extracted from all steps
2. All values collected from user
3. BUILD_CONFIG.json created with valid JSON
4. All verification checks pass
5. Documentation created with timing
6. BUILD_STATUS.md updated (or created)

## Common Issues

### Issue: Step file not found
**Symptom**: Can't read ybs-step_<guid>.md
**Solution**: Check STEPS_ORDER.txt for correct GUID, ensure file exists

### Issue: Invalid JSON generated
**Symptom**: JSON validation fails
**Solution**: Check for unescaped quotes in user input, validate JSON structure

### Issue: Duplicate keys with different types
**Symptom**: Same key has different type definitions in different steps
**Solution**: Use first occurrence, warn user about inconsistency

### Issue: Too many configuration values
**Symptom**: More than 12-16 values to collect
**Solution**: Break into multiple AskUserQuestion batches (4 per batch max)

## Next Steps

After completing this step, proceed to:
- **Next step**: First step in STEPS_ORDER.txt (usually ybs-step_478a8c4b0cef)

---

## Notes for Step Authors

**When creating new steps:**
1. Mark all configurable values with `{{CONFIG:key|type|desc|default}}`
2. Use clear, descriptive key names (snake_case)
3. Provide good descriptions (shown to user)
4. Choose appropriate defaults
5. Use choice[...] for limited options
6. Keep choices to 2-4 options when possible

**Config marker placement:**
- Place in "Configurable Values" section
- Also use inline in instructions where value is needed
- Example: "Create directory `builds/{{CONFIG:system_name}}/src`"

---

**Version**: 0.1.0
**Created**: 2026-01-17
**Last Updated**: 2026-01-17
